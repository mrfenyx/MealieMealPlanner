<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Meal Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans">
    <header class="bg-orange-500 px-6 py-4 flex justify-between items-center shadow-md">
        <h1 class="text-2xl font-bold">ðŸ¥— Weekly Meal Plan</h1>
        <a href="{{ url_for('view_done') }}"
            class="flex items-center gap-2 bg-orange-500 text-white font-semibold px-4 py-2 rounded hover:bg-orange-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
            </svg>
            View Done
        </a>
    </header>

    <main class="p-6">
        {% if items %}
            <div class="flex flex-wrap gap-6 justify-center">
                {% for item in items %}
                    <div class="relative bg-gray-800 rounded-lg shadow-md overflow-hidden h-[12rem] w-full max-w-sm flex flex-col md:flex-row">
                        <!-- Dropdown Menu -->
                        <div class="absolute top-1 right-0 z-10">
                            <button class="text-white hover:text-orange-400 focus:outline-none dropdown-toggle" data-menu-id="{{ item.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                    <path d="M12 7a1.5 1.5 0 110-3 1.5 1.5 0 010 3zM12 13.5a1.5 1.5 0 110-3 1.5 1.5 0 010 3zM12 20a1.5 1.5 0 110-3 1.5 1.5 0 010 3z" />
                                </svg>
                            </button>
                            <div class="hidden absolute right-0 mt-2 w-max bg-gray-900 text-white text-sm rounded-lg shadow-lg dropdown-menu" id="menu-{{ item.id }}">
                                <button class="w-full flex items-center gap-2 px-4 py-2 hover:bg-gray-700 markdone-action" data-meal-id="{{ item.id }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                    </svg>
                                    Done
                                </button>
                                <button class="w-full flex items-center gap-2 px-4 py-2 hover:bg-gray-700 remove-action" data-meal-id="{{ item.id }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                    Delete
                                </button>
                            </div>
                        </div>

                        <!-- Image -->
                        <img src="{{ item.image_url or 'https://via.placeholder.com/200x140?text=No+Image' }}"
                             class="w-32 object-cover object-center flex-shrink-0"
                             alt="Image for {{ item.recipe.name }}">

                        <!-- Content -->
                        <div class="p-4 flex flex-col flex-grow">
                            <!-- Title + Description -->
                            <div>
                                <h2 class="text-lg font-bold mb-2 leading-snug line-clamp-2">
                                    <a href="{{ item.recipe_url }}" class="text-orange-400 hover:underline" target="_blank">{{ item.recipe.name }}</a>
                                </h2>
                                <p class="text-sm text-gray-300 line-clamp-3">
                                    {{ item.recipe.description }}
                                </p>
                            </div>

                            <!-- Timing Info pinned to bottom -->
                            {% set prep = (item.recipe.prepTime.split()[0]|int) if item.recipe.prepTime else 0 %}
                            {% set perform = (item.recipe.performTime.split()[0]|int) if item.recipe.performTime else 0 %}
                            {% set total = prep + perform %}

                            <div class="mt-auto pt-4 flex justify-between text-sm text-gray-300">
                                <div class="flex items-center gap-1 group relative">
                                    <!-- Clock Icon (Total Time) -->
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 20C16.4 20 20 16.4 20 12S16.4 4 12 4 4 7.6 4 12 7.6 20 12 20M12 2C17.5 2 22 6.5 22 12S17.5 22 12 22C6.5 22 2 17.5 2 12C2 6.5 6.5 2 12 2M17 13.9L16.3 15.2L11 12.3V7H12.5V11.4L17 13.9Z" />
                                    </svg>
                                    {{ total }} min
                                    <span class="absolute bottom-full mb-1 left-1/2 -translate-x-1/2 whitespace-nowrap bg-black text-white text-xs rounded py-1 px-2 opacity-0 group-hover:opacity-100 transition pointer-events-none z-10">
                                        Total Time
                                    </span>
                                </div>
                                <div class="flex items-center gap-1 group relative">
                                    <!-- Knife Icon (Prep Time) -->
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.62,2C23.97,7.61 12.47,20.15 12.47,20.15L9.6,17.28L4.91,22L2.77,19.86L20.62,2Z" />
                                    </svg>
                                    {{ prep }} min
                                    <span class="absolute bottom-full mb-1 left-1/2 -translate-x-1/2 whitespace-nowrap bg-black text-white text-xs rounded py-1 px-2 opacity-0 group-hover:opacity-100 transition pointer-events-none z-10">
                                        Prep Time
                                    </span>
                                </div>
                                <div class="flex items-center gap-1 group relative">
                                    <!-- Pot Icon (Cook Time) -->
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 1.5C6.15 1.5 4.65 3 4.65 4.85C4.65 6.7 6.15 8.2 8 8.2H9.53C9.92 8.2 10.29 8.3 10.61 8.5H12.63C12.05 7.45 10.86 6.75 9.53 6.75H8C7 6.75 6.15 5.77 6.15 4.75C6.15 3.73 7 3 8 3V1.5M12.85 2C12.85 3 12 3.85 11 3.85V5.35C12.92 5.35 14.5 6.7 14.89 8.5H16.42C16.12 6.67 14.96 5.15 13.35 4.38C13.97 3.77 14.35 2.93 14.35 2H12.85M3 10V12H5V19C5 20.11 5.9 21 7 21H17C18.11 21 19 20.11 19 19V12H21V10H3M7 12H17V19H7V12Z" />
                                    </svg>
                                    {{ perform }} min
                                    <span class="absolute bottom-full mb-1 left-1/2 -translate-x-1/2 whitespace-nowrap bg-black text-white text-xs rounded py-1 px-2 opacity-0 group-hover:opacity-100 transition pointer-events-none z-10">
                                        Cook Time
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-center text-gray-400 mt-8">No meals found for this date range.</p>
        {% endif %}
    </main>

    <script>
        document.querySelectorAll(".dropdown-toggle").forEach(button => {
            button.addEventListener("click", () => {
                const id = button.getAttribute("data-menu-id");
                document.querySelectorAll(".dropdown-menu").forEach(menu => {
                    if (menu.id === "menu-" + id) {
                        menu.classList.toggle("hidden");
                    } else {
                        menu.classList.add("hidden");
                    }
                });
            });
        });

        document.addEventListener("click", (e) => {
            if (!e.target.closest(".dropdown-toggle") && !e.target.closest(".dropdown-menu")) {
                document.querySelectorAll(".dropdown-menu").forEach(menu => menu.classList.add("hidden"));
            }
        });

        document.querySelectorAll(".markdone-action").forEach(button => {
            button.addEventListener("click", () => {
                const id = button.getAttribute("data-meal-id");
                fetch(`/done/${id}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                }).then(res => res.json())
                  .then(data => {
                      if (data.success) {
                          button.closest(".bg-gray-800").remove();
                      } else {
                          alert("Failed to mark as done.");
                      }
                  });
            });
        });

        document.querySelectorAll(".remove-action").forEach(button => {
            button.addEventListener("click", () => {
                const id = button.getAttribute("data-meal-id");
                fetch(`/remove/${id}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                }).then(res => res.json())
                  .then(data => {
                      if (data.success) {
                          button.closest(".bg-gray-800").remove();
                      } else {
                          alert("Failed to remove meal.");
                      }
                  });
            });
        });
    </script>
</body>
</html>
